#GCP 

他のGCPのサービス同様いろんなこと出来る+概念が複雑 なので実装の仕方ベースで考えてもらうと良いと思う。

あらかじめ設定されたイベントをトリガーにアプリケーションを実行できるサービス。
基本的にPython, Javascript, Go等でクライアントライブラリを用いて`Pub/Subメッセージ` を送受信することが出来る。 cf. [Pub/Subメッセージの作成とレスポンス](https://cloud.google.com/appengine/docs/flexible/python/writing-and-responding-to-pub-sub-messages?hl=ja)
メッセージはクライアントライブラリを使用せずとも、任意のエンドポイントに`HTTPS` を用いて送信することも可能。（多分受信、エンドポイントとして使うのは無理、というかそれができたらトリガーの意味がない気がする）

基本的にはすべてのGCPアプリケーションを横断して制御出来る。
定期実行、同時実行、フロー制御（送信タイミングのコントロール）などが出来、大抵の制御がデフォルトで出来るようになっている。

詳しくは[公式ドキュメント](https://cloud.google.com/pubsub?hl=ja)を参照されたい。

トピックとサブスクライバー、パブリッシャー、メッセージという用語を理解してもらいたい。

## トピック

`Pub/Sub` のルールを追加する場所のようなもの。

## メッセージ

メールとかLINEメッセージとかそういう類の言葉ではなく、イベント検知→トリガーまでの信号のこと。

## パブリッシャーとサブスクライバー

### パブリッシャー

1.  データを含むメッセージを作成します。
2.  リクエストを Pub/Sub サーバーに送信し、目的のトピックにメッセージをパブリッシュします。

### サブスクライバー

`Pub/Sub` のルール登録のようなもの。

#### pull サブスクリプション

pull 配信では、サブスクライバー アプリケーションが Pub/Sub サーバーに対してメッセージ取得のリクエストを開始します。

1.  サブスクライブしているアプリケーションは、メッセージの配信をリクエストする pull メソッドを明示的に呼び出します。
2.  Pub/Sub サーバーはメッセージ（キューが空の場合はエラー）と確認応答 ID で応答します。
3.  サブスクライバーは戻された確認応答 ID を使用して acknowledge メソッドを明示的に呼び出し、受信を確認します。

![Pullサブスクリプションの概要](https://cloud.google.com/pubsub/images/subscriber_pull.svg?hl=ja)

#### push サブスクリプション

push 配信では、Pub/Sub がサブスクライバー アプリケーションに対してリクエストを開始し、メッセージを配信します。

1.  Pub/Sub サーバーは、事前構成されたエンドポイントで、サブスクライバー アプリケーションに各メッセージを HTTPS リクエストとして送信します。
2.  エンドポイントは、HTTP 成功ステータス コードを返すことでメッセージに確認応答します。不成功のレスポンスは、メッセージを再送信する必要があることを示します。

![](https://cloud.google.com/pubsub/images/subscriber_push.svg?hl=ja)

## Cloud Storageの変更検知をトリガーにする



> Pub/Sub 通知は、バケット内のオブジェクトに変更が加えられるとその情報を [Pub/Sub](https://cloud.google.com/pubsub?hl=ja) に送信します。情報は、メッセージの形式で選択した Pub/Sub トピックに追加されます。これにより、バケット内で作成されたオブジェクトと削除されたオブジェクトの追跡などを行えます。各通知には、トリガーとなったイベントと変更されたオブジェクトの両方の情報が含まれます。

cf. [Cloud Storage の Pub/Sub 通知](https://cloud.google.com/storage/docs/pubsub-notifications?hl=ja) 


### イベントの種類

#### OBJECT_FINALIZE

バケットで新しいオブジェクト（または既存オブジェクトの新しい世代）が正常に作成された場合に送信されます。既存のオブジェクトをコピーまたは再作成した場合にも送信されます。アップロードが失敗した場合、このイベントはトリガーされません。

#### OBJECT_METADATA_UPDATE

既存オブジェクトのメタデータが変更された場合に送信されます。

#### OBJECT_DELETE

オブジェクトが完全に削除された場合に送信されます。バケットの[ライフサイクル構成](https://cloud.google.com/storage/docs/lifecycle?hl=ja)で置換または削除されたオブジェクトも対象になります。[オブジェクトのバージョニング](https://cloud.google.com/storage/docs/object-versioning?hl=ja)が有効になっているバケットについては、`storage.objects.delete` メソッドによってオブジェクトが非現行になっている場合であっても、オブジェクトが非現行になるときにこのイベントは送信されません（`OBJECT_ARCHIVE` をご覧ください）。

#### OBJECT_ARCHIVE

バケットで[オブジェクトのバージョニング](https://cloud.google.com/storage/docs/object-versioning?hl=ja)が有効になっている場合にのみ送信されます。このイベントは、明示的に非現行になったか、同じ名前のオブジェクトのアップロードによって置換されたことにより、オブジェクトのライブ バージョンが非現行バージョンになったことを表します。
